<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>👚 衣櫃上傳（簡化版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* 預覽區的圖片 */
    #preview img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin: 5px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: border-color 0.2s;
    }
    #preview img.selected {
      border-color: #007bff;
    }

    /* 圖片展示區 */
    #closet-gallery {
      display: block;
      padding: 10px;
    }
    {% comment %} #closet-gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* 每排顯示 3 張圖片 */
      gap: 10px;
      padding: 10px;
      min-height: 150px;
      border: 1px solid #ccc;
      border-radius: 8px;
    } {% endcomment %}
    #closet-gallery img {
      width: 100%; /* 圖片填滿格子 */
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
    }

    /* 按鈕樣式 */
    .category-buttons button {
      margin-right: 8px;
      margin-bottom: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }
    .image-row {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #ccc;
      margin-bottom: 20px;
    }

    .image-row::-webkit-scrollbar {
      height: 6px;
    }
    
    .image-row::-webkit-scrollbar-thumb {
      background-color: #ccc;
      border-radius: 4px;
    }
    .gallery-image {
      width: 120px;              
      height: 120px;            
      object-fit: cover;        
      margin: 5px;
      cursor: pointer;
      border-radius: 8px;
      transition: 0.3s;
    }

    .category-title {
      text-align: center;
      font-size: 20px;
      margin: 20px 0 10px;
      color: #333;
      font-weight: bold;
      border-bottom: 2px solid #ddd;
      padding-bottom: 5px;
    }

    .gallery-image.selected {
      border-color: red;
    }

    #filter-buttons {
      margin-bottom: 20px;
    }

    #filter-buttons button {
      margin-right: 10px;
      padding: 5px 10px;
      border-radius: 8px;
      cursor: pointer;
    }



  </style>
</head>
<body>
  <div style="max-width: 600px; margin: 20px auto; text-align: center;">
    <!-- 選擇圖片方式 -->
    <div>
      <input type="file" id="file-input" accept="image/*" multiple style="display:none;" />
      <button type="button" onclick="openImageSourceSelector()">📷 選擇圖片 (本機 / LINE 拍照/相簿)</button>
    </div>

    <!-- 分類與上傳 -->
    <select id="category-select" style="margin-top: 10px;" required> <!-- ✅ 加入 required -->
      <option value="top">上衣</option>
      <option value="bottom">下身</option>
      <option value="shoes">鞋子</option>
      <option value="dress">洋裝</option> 
      <option value="skirt">裙子</option>
      <option value="outwear">外搭衣</option>
    </select>
    <button type="button" onclick="uploadImages()" style="margin-left: 10px;">上傳</button>

    <!-- 狀態區 -->
    <div id="status" style="margin-top: 10px; font-weight: bold;"></div>

    <hr>

    <!-- 圖片篩選與刪除 -->
    <div class="category-buttons" style="margin-bottom: 10px;">
      <button onclick="filterCategory('all')">全部</button>
      <button onclick="filterCategory('top')">只看上衣</button>
      <button onclick="filterCategory('bottom')">只看下身</button>
      <button onclick="filterCategory('shoes')">只看鞋子</button>
      <button onclick="filterCategory('dress')">只看洋裝</button> 
      <button onclick="filterCategory('skirt')">只看裙子</button>
      <button onclick="filterCategory('outwear')">只看外搭衣</button> 
      <button onclick="deleteSelected()">刪除選取圖片</button>
    </div>

    <!-- 圖片展示區 -->
    <div id="closet-gallery"></div>
  </div>

  <!-- LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    const liffId = "2007741127-KXgn38Dn";  // 請換成你的 LIFF ID
    let globalUserId = "";
    let selectedFiles = [];
    let images = [];
    let idCounter = 0;
    let currentFilter = 'all';

    const fileInput = document.getElementById('file-input');
    const status = document.getElementById('status');
    const gallery = document.getElementById('closet-gallery');
    //取得後端資料
    {% comment %} async function fetchGalleryFromBackend() {
      const res = await fetch(`/linebot/view_closet/${globalUserId}/`);
      const data = await res.json();
      images = data.images.map((img, index) => ({
        id: idCounter++,
        file: null,
        category: img.category,
        url: img.url,
        selected: false
      }));
      renderGallery(); // 渲染圖片
    } {% endcomment %}
    
    // LIFF 初始化與登入判斷
    document.addEventListener("DOMContentLoaded", async function () {
      await liff.init({ liffId: "{{ liff_id }}" });
      if (!liff.isLoggedIn()) liff.login();

      const profile = await liff.getProfile();
      globalUserId = profile.userId;

      await fetchGalleryFromBackend();  // 直接呼叫抽出來的函式
    });
 
    async function fetchGalleryFromBackend() {
      try {
        const res = await fetch(`/linebot/view_closet/${globalUserId}/`);
        const data = await res.json();

        images = (data.images || []).map(item => ({
          id: idCounter++,
          url: `/${item.url}`,
          category: item.category,
          selected: false,
          file: null
        }));

        renderGallery();
      } catch (error) {
        console.error("載入失敗", error);
        status.innerText = '載入衣櫃圖片失敗';
      }
    }



 

    // 「選擇圖片」按鈕會彈選擇框，先讓用戶選擇本機還是 LINE 拍照/相簿
    async function openImageSourceSelector() {
      const choice = confirm("點選「確定」用 LINE 拍照/相簿，點選「取消」用本機選擇");
      if (choice) {
        await pickImages(); // LINE 拍照/相簿
      } else {
        fileInput.click(); // 本機選擇
      }
    }

    // 本機選擇檔案觸發
    fileInput.addEventListener('change', () => {
      const input = fileInput;
      const files = Array.from(input.files);
      if (files.length === 0) {
        status.innerText = '請選擇圖片';
        return;
      }
      selectedFiles = files;
      status.innerText = `已從本機選擇 ${files.length} 張圖片，請選擇分類並上傳`;
    });

    // LINE 拍照/相簿選圖片
    async function pickImages() {
      try {
        const media = await liff.chooseMedia({
          count: 5,
          mediaType: ['image'],
          source: ['camera', 'gallery']
        });

        if (!media || media.length === 0) {
          status.innerText = '未選擇任何圖片';
          return;
        }

        selectedFiles = media.map((item, index) =>
          new File([item.blob], `image_${Date.now()}_${index}.jpg`, { type: item.mimeType })
        );

        status.innerText = `已從 LINE 拍照/相簿選擇 ${selectedFiles.length} 張圖片，請選擇分類並上傳`;
      } catch (err) {
        console.error('選擇圖片錯誤:', err);
        status.innerText = '選擇圖片失敗，請再試一次';
      }
    }

    // 上傳圖片
    function uploadImages() {
      if (selectedFiles.length === 0) {
        alert('請先選擇圖片');
        return;
      }

      const category = document.getElementById('category-select').value;
      if (!category) {
        alert('請先選擇分類再上傳'); // ✅ 防呆提醒
        return;
      }

      selectedFiles.forEach(file => {
        const url = URL.createObjectURL(file);
        images.push({ id: idCounter++, file, category, url, selected: false });
      });

      status.innerText = `已新增 ${selectedFiles.length} 張圖片到分類「${category}」`;
      fileInput.value = '';
      renderGallery();

      sendToBackend();  // ✅ category 會一起傳給後端
    }
     
    //加入 AJAX 上傳與讀取後端資料
    
    async function sendToBackend() {
      const category = document.getElementById('category-select').value;
      const formData = new FormData();
      formData.append('userId', globalUserId);
      formData.append('category', category);

      selectedFiles.forEach((file) => {
        formData.append('images', file);
      });

      const res = await fetch('/linebot/upload_closet/', {
        method: 'POST',
        body: formData,
      });

      const result = await res.json();
      if (result.status === 'success') {
        status.innerText = '圖片上傳成功！';
        await fetchGalleryFromBackend();  // 重新渲染
      } else {
        status.innerText = '圖片上傳失敗';
      }
    }

    // 篩選分類並渲染展示區
    {% comment %} function renderGallery() {
      gallery.innerHTML = '';
      const filtered = currentFilter === 'all' ? images : images.filter(img => img.category === currentFilter);
      if (filtered.length === 0) {
        gallery.innerHTML = '<p style="color:#666;">沒有符合條件的圖片</p>';
        return;
      }
      filtered.forEach(img => {
        const wrapper = document.createElement('div');
        wrapper.classList.add('image-wrapper');

        const imgEl = document.createElement('img');
        imgEl.src = img.url;
        imgEl.alt = img.file.name;
        imgEl.title = `${img.file.name} (${img.category})`;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'delete-checkbox';
        checkbox.value = img.url;

        wrapper.appendChild(imgEl);
        wrapper.appendChild(checkbox);
        gallery.appendChild(wrapper);
      });
    } {% endcomment %}
    {% comment %} function renderGallery() {
      gallery.innerHTML = '';
      const filtered = currentFilter === 'all' ? images : images.filter(img => img.category === currentFilter);

      if (filtered.length === 0) {
        gallery.innerHTML = '<p style="color:#666;">沒有符合條件的圖片</p>';
        return;
      }

      filtered.forEach(img => {
        const wrapper = document.createElement('div');
        wrapper.classList.add('image-wrapper');

        const imgEl = document.createElement('img');
        imgEl.src = img.url;
        imgEl.alt = img.file?.name || '後端圖片';
        imgEl.title = `${img.category}`;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'delete-checkbox';
        checkbox.value = img.url;

        wrapper.appendChild(imgEl);
        wrapper.appendChild(checkbox);
        gallery.appendChild(wrapper);
      });
    } {% endcomment %}
    function renderGallery() {
      const gallery = document.getElementById('closet-gallery');
      gallery.innerHTML = '';

      const grouped = {};

      images.forEach(img => {
        if (!grouped[img.category]) {
          grouped[img.category] = [];
        }
        grouped[img.category].push(img);
      });

      const categoryMap = {
        top: '上衣',
        bottom: '下身',
        shoes: '鞋子',
        dress: '洋裝',
        skirt: '裙子',
        outwear: '外搭衣'
      };

      for (const category in grouped) {
      // ➤ 加入篩選條件
        if (currentCategoryFilter !== 'all' && category !== currentCategoryFilter) {
          continue;
        }


        

        const categoryTitle = document.createElement('h3');
        categoryTitle.className = 'category-title'; // ✅ 加 class
        categoryTitle.innerText = `${category}（${categoryMap[category] || category}）`;
        gallery.appendChild(categoryTitle);

        const row = document.createElement('div');
        row.className = 'image-row scrollable-row';  // 加上可捲動樣式

        grouped[category].forEach(img => {
          const imgEl = document.createElement('img');
          imgEl.src = img.url;
          imgEl.className = 'gallery-image';
          imgEl.onclick = () => toggleSelection(img.id);
          if (img.selected) {
            imgEl.classList.add('selected');
          }
          row.appendChild(imgEl);
        });

        gallery.appendChild(row);
      }
    }


    // 篩選按鈕
    let currentCategoryFilter = 'all';  // 預設顯示全部

    function filterCategory(category) {
      currentCategoryFilter = category;
      renderGallery();  // 重新渲染圖片
    }

    // 刪除選取圖片
    function deleteSelected() {
      const checked = document.querySelectorAll('input[name="delete-checkbox"]:checked');
      if (checked.length === 0) {
        alert('請先選擇要刪除的圖片');
        return;
      }
      const paths = Array.from(checked).map(cb => cb.value);

      images = images.filter(img => !paths.includes(`/${img.url}`)); // 移除已選擇的圖片
      paths.forEach(path => URL.revokeObjectURL(path)); // 釋放記憶體
      status.innerText = '已刪除選取的圖片';
      renderGallery();
    }

    {% comment %} document.addEventListener("DOMContentLoaded", async function () {
      await liff.init({ liffId: "{{ liff_id }}" });
      if (!liff.isLoggedIn()) liff.login();

      const profile = await liff.getProfile();
      const userId = profile.userId;

      const res = await fetch(`/linebot/view_closet/${globalUserId}/`);
      const data = await res.json();

      const imageList = data.images;
      imageList.forEach(item => {
        const img = {
          id: idCounter++,
          url: item.url,
          category: item.category,
          selected: false,
          file: null
        };
        images.push(img);
      });

      renderGallery();
    }); {% endcomment %}
  </script>
</body>
</html>

