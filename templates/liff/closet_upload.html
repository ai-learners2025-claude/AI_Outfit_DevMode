{% include   "components\header.html" %}

<html lang="zh-Hant">
<head>

  <meta charset="UTF-8" />
  <title>ğŸ‘š è¡£æ«ƒä¸Šå‚³ï¼ˆç°¡åŒ–ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* é è¦½å€çš„åœ–ç‰‡ */
    #preview img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin: 5px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: border-color 0.2s;
    }
    #preview img.selected {
      border-color: #007bff;
    }

    /* åœ–ç‰‡å±•ç¤ºå€ */
    #closet-gallery {
      display: block;
      padding: 10px;
    }
    {% comment %} #closet-gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* æ¯æ’é¡¯ç¤º 3 å¼µåœ–ç‰‡ */
      gap: 10px;
      padding: 10px;
      min-height: 150px;
      border: 1px solid #ccc;
      border-radius: 8px;
    } {% endcomment %}
    #closet-gallery img {
      width: 100%; /* åœ–ç‰‡å¡«æ»¿æ ¼å­ */
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .category-buttons button {
      margin-right: 8px;
      margin-bottom: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }
    .image-row {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #ccc;
      margin-bottom: 20px;
    }

    .image-row::-webkit-scrollbar {
      height: 6px;
    }
    
    .image-row::-webkit-scrollbar-thumb {
      background-color: #ccc;
      border-radius: 4px;
    }
    .gallery-image {
      width: 120px;              
      height: 120px;            
      object-fit: cover;        
      margin: 5px;
      cursor: pointer;
      border-radius: 8px;
      transition: 0.3s;
    }

    .category-title {
      text-align: center;
      font-size: 20px;
      margin: 20px 0 10px;
      color: #333;
      font-weight: bold;
      border-bottom: 2px solid #ddd;
      padding-bottom: 5px;
    }

    .gallery-image.selected {
      border-color: red;
    }

    #filter-buttons {
      margin-bottom: 20px;
    }

    #filter-buttons button {
      margin-right: 10px;
      padding: 5px 10px;
      border-radius: 8px;
      cursor: pointer;
    }

  </style>
</head>
<body>
  <div style="max-width: 600px; margin: 20px auto; text-align: center;">
    <!-- é–‹ç™¼æ¨¡å¼æç¤º -->
    <div id="dev-mode-indicator" style="background-color: #ffeb3b; color: #333; padding: 8px; border-radius: 4px; margin-bottom: 10px; display: none;">
      ğŸš€ é–‹ç™¼æ¨¡å¼ï¼šä½¿ç”¨æ¸¬è©¦ UserId
    </div>
    
    <!-- é¸æ“‡åœ–ç‰‡æ–¹å¼ -->
    <div>
      <input type="file" id="file-input" accept="image/*" multiple style="display:none;" />
      <button type="button" onclick="openImageSourceSelector()">ğŸ“· é¸æ“‡åœ–ç‰‡ (æœ¬æ©Ÿ / LINE æ‹ç…§/ç›¸ç°¿)</button>
    </div>

    <!-- åˆ†é¡èˆ‡ä¸Šå‚³ -->
    <select id="category-select" style="margin-top: 10px;" required> <!-- âœ… åŠ å…¥ required -->
      <option value="top">ä¸Šè¡£</option>
      <option value="bottom">ä¸‹èº«</option>
      <option value="shoes">é‹å­</option>
      <option value="dress">æ´‹è£</option> 
      <option value="skirt">è£™å­</option>
      <option value="outwear">å¤–æ­è¡£</option>
    </select>
    <button type="button" onclick="uploadImages()" style="margin-left: 10px;">ä¸Šå‚³</button>

    <!-- ç‹€æ…‹å€ -->
    <div id="status" style="margin-top: 10px; font-weight: bold;"></div>

    <hr>

    <!-- åœ–ç‰‡ç¯©é¸èˆ‡åˆªé™¤ -->
    <div class="category-buttons" style="margin-bottom: 10px;">
      <button onclick="filterCategory('all')">å…¨éƒ¨</button>
      <button onclick="filterCategory('top')">åªçœ‹ä¸Šè¡£</button>
      <button onclick="filterCategory('bottom')">åªçœ‹ä¸‹èº«</button>
      <button onclick="filterCategory('shoes')">åªçœ‹é‹å­</button>
      <button onclick="filterCategory('dress')">åªçœ‹æ´‹è£</button> 
      <button onclick="filterCategory('skirt')">åªçœ‹è£™å­</button>
      <button onclick="filterCategory('outwear')">åªçœ‹å¤–æ­è¡£</button> 
      <button onclick="deleteSelected()">åˆªé™¤é¸å–åœ–ç‰‡</button>
    </div>

    <!-- åœ–ç‰‡å±•ç¤ºå€ -->
    <div id="closet-gallery"></div>
  </div>

  <!-- LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    const liffId = "2007741127-KXgn38Dn";  // è«‹æ›æˆä½ çš„ LIFF ID
    // é–‹ç™¼æ¨¡å¼åˆ¤æ–· - å¯ä»¥é€é URL åƒæ•¸ ?dev=1 ä¾†é–‹å•Ÿé–‹ç™¼æ¨¡å¼
    const isDevelopmentMode = {% if debug %}true{% else %}false{% endif %} || new URLSearchParams(window.location.search).get('dev') === '1';
    const DEV_USER_ID = "dev_test_user_12345";  // é–‹ç™¼æ¨¡å¼å›ºå®š UserId
    
    let globalUserId = "";
    let selectedFiles = [];
    let images = [];
    let idCounter = 0;
    let currentFilter = 'all';

    const fileInput = document.getElementById('file-input');
    const status = document.getElementById('status');
    const gallery = document.getElementById('closet-gallery');
    //å–å¾—å¾Œç«¯è³‡æ–™
    
    // LIFF åˆå§‹åŒ–èˆ‡ç™»å…¥åˆ¤æ–·ï¼ˆå«é–‹ç™¼æ¨¡å¼æ”¯æ´ï¼‰
    document.addEventListener("DOMContentLoaded", async function () {
      // é¡¯ç¤ºé–‹ç™¼æ¨¡å¼æŒ‡ç¤ºå™¨
      if (isDevelopmentMode) {
        document.getElementById('dev-mode-indicator').style.display = 'block';
      }
      
      if (isDevelopmentMode) {
        // é–‹ç™¼æ¨¡å¼ï¼šè·³é LIFF é©—è­‰ï¼Œä½¿ç”¨å›ºå®š UserId
        console.log("ğŸš€ é–‹ç™¼æ¨¡å¼ï¼šè·³é LINE LIFF é©—è­‰");
        globalUserId = DEV_USER_ID;
        status.innerText = `é–‹ç™¼æ¨¡å¼ï¼šä½¿ç”¨æ¸¬è©¦ UserId: ${DEV_USER_ID}`;
        await fetchGalleryFromBackend();
      } else {
        // æ­£å¼æ¨¡å¼ï¼šä½¿ç”¨ LINE LIFF é©—è­‰
        try {
          await liff.init({ liffId: "{{ liff_id }}" });
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            const profile = await liff.getProfile();
            globalUserId = profile.userId;
            console.log("LINE UserId:", globalUserId);
            status.innerText = "å·²é€šé LINE é©—è­‰";
            await fetchGalleryFromBackend();
          }
        } catch (err) {
          console.error("LIFF åˆå§‹åŒ–éŒ¯èª¤", err);
          status.innerText = 'LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†';
        }
      }
    });
 
    async function fetchGalleryFromBackend() {
      try {
        const res = await fetch(`/linebot/view_closet/${globalUserId}/`);
        const data = await res.json();

        images = (data.images || []).map(item => ({
          id: idCounter++,
          url: `/${item.url}`,
          category: item.category,
          selected: false,
          file: null
        }));

        renderGallery();
      } catch (error) {
        console.error("è¼‰å…¥å¤±æ•—", error);
        status.innerText = 'è¼‰å…¥è¡£æ«ƒåœ–ç‰‡å¤±æ•—';
      }    }


    // ã€Œé¸æ“‡åœ–ç‰‡ã€æŒ‰éˆ•æœƒå½ˆé¸æ“‡æ¡†ï¼Œå…ˆè®“ç”¨æˆ¶é¸æ“‡æœ¬æ©Ÿé‚„æ˜¯ LINE æ‹ç…§/ç›¸ç°¿
    async function openImageSourceSelector() {
      if (isDevelopmentMode) {
        // é–‹ç™¼æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨æœ¬æ©Ÿé¸æ“‡
        fileInput.click();
        return;
      }
      
      const choice = confirm("é»é¸ã€Œç¢ºå®šã€ç”¨ LINE æ‹ç…§/ç›¸ç°¿ï¼Œé»é¸ã€Œå–æ¶ˆã€ç”¨æœ¬æ©Ÿé¸æ“‡");
      if (choice) {
        await pickImages(); // LINE æ‹ç…§/ç›¸ç°¿
      } else {
        fileInput.click(); // æœ¬æ©Ÿé¸æ“‡
      }
    }

    // æœ¬æ©Ÿé¸æ“‡æª”æ¡ˆè§¸ç™¼
    fileInput.addEventListener('change', () => {
      const input = fileInput;
      const files = Array.from(input.files);
      if (files.length === 0) {
        status.innerText = 'è«‹é¸æ“‡åœ–ç‰‡';
        return;
      }
      selectedFiles = files;
      status.innerText = `å·²å¾æœ¬æ©Ÿé¸æ“‡ ${files.length} å¼µåœ–ç‰‡ï¼Œè«‹é¸æ“‡åˆ†é¡ä¸¦ä¸Šå‚³`;
    });

    // LINE æ‹ç…§/ç›¸ç°¿é¸åœ–ç‰‡ï¼ˆé–‹ç™¼æ¨¡å¼æœƒè·³éï¼‰
    async function pickImages() {
      if (isDevelopmentMode) {
        // é–‹ç™¼æ¨¡å¼ï¼šæé†’ä½¿ç”¨è€…æ”¹ç”¨æœ¬æ©Ÿé¸æ“‡
        alert('é–‹ç™¼æ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨ LINE æ‹ç…§/ç›¸ç°¿åŠŸèƒ½ï¼Œè«‹é¸æ“‡æœ¬æ©Ÿåœ–ç‰‡');
        fileInput.click();
        return;
      }

      try {
        const media = await liff.chooseMedia({
          count: 5,
          mediaType: ['image'],
          source: ['camera', 'gallery']
        });

        if (!media || media.length === 0) {
          status.innerText = 'æœªé¸æ“‡ä»»ä½•åœ–ç‰‡';
          return;
        }

        selectedFiles = media.map((item, index) =>
          new File([item.blob], `image_${Date.now()}_${index}.jpg`, { type: item.mimeType })
        );

        status.innerText = `å·²å¾ LINE æ‹ç…§/ç›¸ç°¿é¸æ“‡ ${selectedFiles.length} å¼µåœ–ç‰‡ï¼Œè«‹é¸æ“‡åˆ†é¡ä¸¦ä¸Šå‚³`;
      } catch (err) {
        console.error('é¸æ“‡åœ–ç‰‡éŒ¯èª¤:', err);
        status.innerText = 'é¸æ“‡åœ–ç‰‡å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡';
      }
    }

    // ä¸Šå‚³åœ–ç‰‡
    function uploadImages() {
      if (selectedFiles.length === 0) {
        alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡');
        return;
      }

      const category = document.getElementById('category-select').value;
      if (!category) {
        alert('è«‹å…ˆé¸æ“‡åˆ†é¡å†ä¸Šå‚³'); // âœ… é˜²å‘†æé†’
        return;
      }

      selectedFiles.forEach(file => {
        const url = URL.createObjectURL(file);
        images.push({ id: idCounter++, file, category, url, selected: false });
      });

      status.innerText = `å·²æ–°å¢ ${selectedFiles.length} å¼µåœ–ç‰‡åˆ°åˆ†é¡ã€Œ${category}ã€`;
      fileInput.value = '';
      renderGallery();

      sendToBackend();  // âœ… category æœƒä¸€èµ·å‚³çµ¦å¾Œç«¯
    }
     
    //åŠ å…¥ AJAX ä¸Šå‚³èˆ‡è®€å–å¾Œç«¯è³‡æ–™
    
    async function sendToBackend() {
      const category = document.getElementById('category-select').value;
      const formData = new FormData();
      formData.append('userId', globalUserId);
      formData.append('category', category);

      selectedFiles.forEach((file) => {
        formData.append('images', file);
      });

      const res = await fetch('/linebot/upload_closet/', {
        method: 'POST',
        body: formData,
      });

      const result = await res.json();
      if (result.status === 'success') {
        status.innerText = 'åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼';
        await fetchGalleryFromBackend();  // é‡æ–°æ¸²æŸ“
      } else {
        status.innerText = 'åœ–ç‰‡ä¸Šå‚³å¤±æ•—';
      }
    }    // ç¯©é¸åˆ†é¡ä¸¦æ¸²æŸ“å±•ç¤ºå€
    function renderGallery() {
      const gallery = document.getElementById('closet-gallery');
      gallery.innerHTML = '';

      const grouped = {};

      images.forEach(img => {
        if (!grouped[img.category]) {
          grouped[img.category] = [];
        }
        grouped[img.category].push(img);
      });

      const categoryMap = {
        top: 'ä¸Šè¡£',
        bottom: 'ä¸‹èº«',
        shoes: 'é‹å­',
        dress: 'æ´‹è£',
        skirt: 'è£™å­',
        outwear: 'å¤–æ­è¡£'
      };

      for (const category in grouped) {
      // â¤ åŠ å…¥ç¯©é¸æ¢ä»¶
        if (currentCategoryFilter !== 'all' && category !== currentCategoryFilter) {
          continue;
        }

        const categoryTitle = document.createElement('h3');
        categoryTitle.className = 'category-title'; // âœ… åŠ  class
        categoryTitle.innerText = `${category}ï¼ˆ${categoryMap[category] || category}ï¼‰`;
        gallery.appendChild(categoryTitle);

        const row = document.createElement('div');
        row.className = 'image-row scrollable-row';  // åŠ ä¸Šå¯æ²å‹•æ¨£å¼

        grouped[category].forEach(img => {
          const imgEl = document.createElement('img');
          imgEl.src = img.url;
          imgEl.className = 'gallery-image';
          imgEl.onclick = () => toggleSelection(img.id);
          if (img.selected) {
            imgEl.classList.add('selected');
          }
          row.appendChild(imgEl);
        });

        gallery.appendChild(row);
      }
    }


    // ç¯©é¸æŒ‰éˆ•
    let currentCategoryFilter = 'all';  // é è¨­é¡¯ç¤ºå…¨éƒ¨

    function filterCategory(category) {
      currentCategoryFilter = category;
      renderGallery();  // é‡æ–°æ¸²æŸ“åœ–ç‰‡
    }

    // åˆ‡æ›åœ–ç‰‡é¸ä¸­ç‹€æ…‹
    function toggleSelection(imageId) {
      const image = images.find(img => img.id === imageId);
      if (image) {
        image.selected = !image.selected;
        renderGallery();
      }
    }

    // åˆªé™¤é¸å–åœ–ç‰‡
    function deleteSelected() {
      const selectedImages = images.filter(img => img.selected);     
      if (selectedImages.length === 0) {
        alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„åœ–ç‰‡');
        return;
      }
      
      if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${selectedImages.length} å¼µåœ–ç‰‡å—ï¼Ÿ`)) {
        images = images.filter(img => !img.selected);
        status.innerText = `å·²åˆªé™¤ ${selectedImages.length} å¼µåœ–ç‰‡`;
        renderGallery();
      }
    }
  </script>
</body>
</html>

